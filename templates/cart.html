<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - {{ branding.site_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container">
            <h1 class="logo">
                {% if branding.logo_path %}
                    <img src="{{ url_for('static', filename=branding.logo_path) }}" alt="{{ branding.site_name }}" style="max-height: 40px; vertical-align: middle;">
                {% else %}
                    {{ branding.site_name }}
                {% endif %}
            </h1>
            <nav role="navigation">
                <a href="/" aria-label="Shop page">Shop</a>
                <a href="/cart" aria-label="Cart page">Cart <span id="cart-count">{{ cart_count }}</span></a>
                <a href="{{ url_for('orders', role='seller') }}" aria-label="Orders page">Orders</a>
            </nav>
        </div>
    </header>

    <section class="cart-section">
        <div class="container">
            <h2>Your Cart</h2>
            <div class="cart-items">
                <table class="cart-table" id="cart-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cart-table-body"></tbody>
                </table>
            </div>
            <p class="cart-total" id="cart-total">Total: UGX 0.00</p>
            <a href="/checkout" class="btn checkout-btn" aria-label="Proceed to checkout">Checkout</a>
        </div>
    </section>

    <footer role="contentinfo">
        <div class="container">
            <p>Â© 2025 {{ branding.site_name }}. All rights reserved.</p>
        </div>
    </footer>

    {% include 'modal.html' %}

    <script>
        function toggleFooter() {
            const footer = document.querySelector('footer');
            const bodyHeight = document.body.scrollHeight;
            const viewportHeight = window.innerHeight;
            const scrollPosition = window.scrollY + viewportHeight;

            if (bodyHeight <= viewportHeight) {
                footer.style.display = 'none';
            } else {
                footer.style.display = (scrollPosition >= bodyHeight - 10) ? 'block' : 'none';
            }
        }

        window.addEventListener('load', toggleFooter);
        window.addEventListener('scroll', toggleFooter);
        window.addEventListener('resize', toggleFooter);

        function updateCartCount() {
            fetch('/cart/data')
            .then(response => response.json())
            .then(data => {
                document.getElementById('cart-count').textContent = data.cart_count;
            })
            .catch(error => console.error('Error updating cart count:', error));
        }

        function loadCart() {
            fetch('/cart/data')
            .then(response => response.json())
            .then(data => {
                const cartTableBody = document.getElementById('cart-table-body');
                const cartTotal = document.getElementById('cart-total');
                cartTableBody.innerHTML = '';
                if (data.items.length === 0) {
                    cartTableBody.innerHTML = '<tr><td colspan="4" class="message">Your cart is empty.</td></tr>';
                } else {
                    data.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-label="Product Name">${item.name}</td>
                            <td data-label="Price" class="price">UGX ${item.price.toFixed(2)}</td>
                            <td data-label="Quantity">
                                <input type="number" min="1" value="${item.quantity}" class="quantity-input" id="quantity-${item.id}" aria-label="Quantity for ${item.name}">
                            </td>
                            <td data-label="Actions">
                                <button class="btn remove-btn" onclick="removeFromCart(${item.id})" aria-label="Remove ${item.name} from cart">Remove</button>
                            </td>
                        `;
                        cartTableBody.appendChild(row);
                    });
                }
                cartTotal.textContent = `Total: UGX ${data.total.toFixed(2)}`;
                document.getElementById('cart-count').textContent = data.cart_count;
            })
            .catch(error => {
                showModal('error', 'Error loading cart: ' + error);
            });
        }

        function removeFromCart(productId) {
            const quantity = document.getElementById(`quantity-${productId}`).value;
            fetch(`/cart/remove/${productId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                showModal('success', data.message);
                loadCart();
            })
            .catch(error => {
                showModal('error', 'Error removing item: ' + error);
            });
        }

        function showModal(type, message) {
            const modal = document.getElementById('modal');
            const modalContent = document.querySelector('.modal-content p');
            modal.className = `modal ${type}`;
            modalContent.textContent = message;
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        window.addEventListener('load', loadCart);
    </script>
</body>
</html>
